const axios = require('axios');

const defaultResponses = {
    "مرحبا": "مرحباً بك في الشركة المصرية للري وشبكات المياه! كيف يمكننا مساعدتك اليوم؟",
    "أنظمة الري": "نقدم مجموعة متنوعة من أنظمة الري الحديثة المناسبة لمختلف المساحات والمحاصيل. هل تبحث عن أنظمة الري بالتنقيط، أو الرش، أو الري المحوري؟",
    "ري بالتنقيط": "نظام الري بالتنقيط هو الأمثل لتوفير المياه وزيادة كفاءة الري. نوفر أنظمة بجودة عالية مع خدمة التركيب والصيانة.",
    "ري بالرش": "أنظمة الري بالرش لدينا مثالية للمساحات المتوسطة والكبيرة وتضمن توزيعاً متساوياً للمياه. نقدم مجموعة متنوعة من الرشاشات لمختلف الاحتياجات.",
    "ري محوري": "أنظمة الري المحوري هي الخيار الأمثل للمساحات الكبيرة والمشاريع الزراعية الواسعة. نوفر أنظمة متطورة مع خدمة التركيب والدعم الفني.",
    "شبكات المياه": "نتخصص في تصميم وتنفيذ شبكات المياه بمختلف أحجامها للمزارع والمشاريع الزراعية والتجارية والسكنية.",
    "مضخات": "نوفر مضخات مياه عالية الجودة بقدرات مختلفة تناسب جميع احتياجات الضخ، مع خدمة التركيب والصيانة.",
    "خدمة الصيانة": "نقدم خدمات صيانة دورية ووقائية لجميع أنظمة الري وشبكات المياه لضمان استمرارية عملها بكفاءة عالية.",
    "قطع غيار": "نوفر قطع غيار أصلية لجميع أنظمة الري وشبكات المياه التي نقدمها، مع إمكانية التوصيل والتركيب.",
    "ما هي سياسة الضمان": "نقدم ضمان لمدة عام على جميع منتجاتنا وخدماتنا، ويشمل ذلك الصيانة المجانية وتبديل القطع التالفة ضمن شروط الضمان.",
    "كيف يمكنني طلب خدمة": "يمكنك طلب خدماتنا من خلال الاتصال بنا أو زيارة فرعنا الرئيسي في القاهرة، أو إرسال استفسار عبر موقعنا الإلكتروني.",
    "أين أجد": "يمكنك الاطلاع على منتجاتنا وخدماتنا من خلال زيارة معرضنا أو تصفح موقعنا الإلكتروني أو التواصل مع فريق المبيعات.",
    "هل لديكم": "لمعرفة توفر منتج أو خدمة معينة، يرجى التواصل مع فريق خدمة العملاء لدينا أو زيارة أقرب معرض.",
    "ما هي طرق الدفع": "نقبل الدفع نقداً، أو بواسطة بطاقات الائتمان، أو التحويل البنكي، كما نوفر أنظمة تقسيط للمشاريع الكبيرة.",
    "هل توصلون إلى": "نقدم خدمة التوصيل والتركيب في جميع أنحاء مصر، مع رسوم إضافية قد تختلف حسب المسافة وحجم المشروع.",
    "كم تكلفة التركيب": "تكلفة التركيب تعتمد على حجم ونوع النظام والموقع. يمكننا تقديم تقدير مجاني بعد معاينة الموقع.",
    "استشارة": "نقدم خدمات استشارية متخصصة في أنظمة الري وشبكات المياه. يمكننا مساعدتك في اختيار النظام المناسب لاحتياجاتك وميزانيتك.",
    "زيارة ميدانية": "يمكننا ترتيب زيارة ميدانية من قبل فريقنا الفني لتقييم احتياجاتك وتقديم الحلول المناسبة.",
    "خصومات": "نقدم خصومات للمشاريع الكبيرة والعملاء الدائمين. يرجى التواصل مع فريق المبيعات لمعرفة العروض الحالية.",
    "كفاءة استخدام المياه": "أنظمتنا مصممة لتحقيق أقصى كفاءة في استهلاك المياه، مما يساعد في خفض التكاليف والحفاظ على الموارد المائية.",
    "شكرا": "شكراً لك! سعداء بمساعدتك. هل هناك شيء آخر يمكننا مساعدتك به في مجال الري أو شبكات المياه؟",
    "أسعار": "تختلف أسعار منتجاتنا وخدماتنا حسب النوع والحجم والمواصفات. هل تبحث عن تقدير لمشروع معين؟"
};

const getDefaultResponse = (message) => {
    message = message.trim().toLowerCase();

    if (defaultResponses[message]) {
        return defaultResponses[message];
    }

    for (const key in defaultResponses) {
        if (message.includes(key.toLowerCase())) {
            return defaultResponses[key];
        }
    }

    return "يمكنني مساعدتك في معرفة المزيد عن أنظمة الري وشبكات المياه التي تقدمها الشركة المصرية، وتقديم استشارات فنية أولية، ومعلومات عن خدمات التركيب والصيانة. كيف يمكنني مساعدتك اليوم؟";
};

const processMessage = async (req, res) => {
    try {
        const { message, history = [] } = req.body;

        if (!message) {
            return res.status(400).json({ error: 'Message is required' });
        }

        try {
            const productsContext = "منتجاتنا وخدماتنا تشمل أنظمة الري بالتنقيط، أنظمة الري بالرش، أنظمة الري المحوري، شبكات المياه للمزارع والمشاريع، مضخات المياه، خدمات التركيب والصيانة، قطع الغيار، والاستشارات الفنية.";

            const messages = [
                {
                    role: 'system',
                    content: `أنت مساعد خدمة عملاء متخصص في الشركة المصرية للري وشبكات المياه.
                    تساعد العملاء في معرفة المزيد عن منتجاتنا وخدماتنا وتقديم استشارات فنية بسيطة.
                    
                    ${productsContext}
                    
                    إرشادات: كن مهذباً، قدم إجابات قصيرة ومفيدة، تحدث باللغة العربية البسيطة. ساعد العملاء في فهم أنظمة الري المناسبة لاحتياجاتهم الزراعية.`
                }
            ];



            messages.push({ role: 'user', content: message });

            console.log("Sending request to OpenAI API...");

            try {

                const response = await axios.post(
                    'https://api.openai.com/v1/chat/completions',
                    {
                        model: 'gpt-3.5-turbo',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 150,
                    },
                    {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_API_KEY}`
                        }
                    }
                );

                console.log("Received response from OpenAI API");

                const reply = response.data.choices[0].message.content;

                res.status(200).json({ reply });
            } catch (apiError) {
                console.error('OpenAI API error:', apiError.message);

                const defaultReply = getDefaultResponse(message);
                console.log("Using default response:", defaultReply);

                res.status(200).json({
                    reply: defaultReply,
                    source: 'local'
                });
            }
        } catch (processingError) {
            console.error('Error processing message:', processingError);

            const defaultReply = getDefaultResponse(message);
            res.status(200).json({
                reply: defaultReply,
                source: 'local'
            });
        }
    } catch (error) {
        console.error('ChatBot error details:', error.message);

        res.status(200).json({
            reply: "يمكنني مساعدتك في معرفة المزيد عن أنظمة الري وشبكات المياه التي تقدمها الشركة المصرية، وتقديم استشارات فنية أولية، ومعلومات عن خدمات التركيب والصيانة. كيف يمكنني مساعدتك اليوم؟",
            source: 'fallback'
        });
    }
};

module.exports = { processMessage }; 